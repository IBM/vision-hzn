#
# Makefile for vision-edge-inception
#

# Check all necessary environment variables
-include ../../env.check.mk

export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

all: publish-service

# Publish a Horizon service (per service.json) and pull image to get its sha256
publish-service:
	docker login -u $(CR_IBM_USERNAME) -p $(CR_IBM_API_KEY_RO_PULL) $(CR_IBM_HOST)
	hzn exchange service publish -O -f horizon/service.definition.json --pull-image -r "$(CR_IBM_HOST):$(CR_IBM_USERNAME):$(CR_IBM_API_KEY_RO_PULL)" 

test-docker-run:
	docker run -e runmode=stayup -e hostname=`hostname` -v `pwd`/vision-edge:/opt/ibm/vision-edge -v `pwd`/vision-edge/volume/run/var:/opt/ibm/vision-edge/var --privileged -u root $(DOCKER_IMAGE):$(SERVICE_VERSION)

# pattern publish. Only to test it needed
#publish-pattern:
#	hzn exchange pattern publish -f horizon/pattern.json

# Remove the local container image
clean:
	rm -f .hzn.json.tmp.mk

# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@

